{% extends "base.html" %}

{% block title %}{% if g.lang=='en' %}Booking{% else %}დაჯავშნა{% endif %} — GreenSpots{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/booking.css') }}">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/logo.png') }}">>
<link rel="stylesheet" href="//cdn.web-fonts.ge/fonts/alk-life/css/alk-life.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<section class="hero-booking">
    <div class="container">
        <h1>{% if g.lang=='en' %}Plan Your Adventure{% else %}დაგეგმე შენი თავგადასავალი{% endif %}</h1>
        <p>{% if g.lang=='en' %}Choose a place, date and create an unforgettable trip in Georgia{% else %}აირჩიე ადგილი, თარიღი და შექმენი დაუვიწყარი მოგზაურობა საქართველოში{% endif %}</p>
    </div>
</section>

<section class="py-5">
    <div class="container">
        <div class="booking-form">
            <form id="bookingForm" method="POST" action="{{ url_for('booking') }}">

                <div class="form-section">
                    <h4>{% if g.lang=='en' %}Select a Place{% else %}აირჩიე ადგილი{% endif %}</h4>
                    <select class="form-select" id="spotSelect" name="spot" required>
                        <option value="" disabled selected>{% if g.lang=='en' %}Choose...{% else %}აირჩიე...{% endif %}</option>
                        {% for spot in spots %}
                            <option value="{{ spot.name }}">{{ spot.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-section">
                    <h4>{% if g.lang=='en' %}Select Date{% else %}აირჩიე თარიღი{% endif %}</h4>
                    <input type="date" class="form-control" id="dateInput" name="date" required>
                </div>

                <div class="form-section">
                    <h4>{% if g.lang=='en' %}Guest Information{% else %}ინფორმაცია სტუმრის შესახებ{% endif %}</h4>
                    <input type="text" class="form-control mb-3" id="nameInput" name="name" placeholder="{% if g.lang=='en' %}Name{% else %}სახელი{% endif %}" required>
                    <input type="email" class="form-control mb-3" id="emailInput" name="email" placeholder="{% if g.lang=='en' %}Email{% else %}ელ. ფოსტა{% endif %}" required>
                    <input type="tel" class="form-control" id="phoneInput" name="phone" placeholder="{% if g.lang=='en' %}Phone{% else %}ტელეფონი{% endif %}" required>
                </div>

                <div class="booking-summary" id="summary" style="display:none;">
                    <h5>{% if g.lang=='en' %}Order Review{% else %}შეკვეთის მიმოხილვა{% endif %}</h5>
                    <p><strong>{% if g.lang=='en' %}Place:{% else %}ადგილი:{% endif %}</strong> <span id="summarySpot"></span></p>
                    <p><strong>{% if g.lang=='en' %}Date:{% else %}თარიღი:{% endif %}</strong> <span id="summaryDate"></span></p>
                    <p><strong>{% if g.lang=='en' %}Guest:{% else %}სტუმარი:{% endif %}</strong> <span id="summaryName"></span></p>
                    <p><strong>{% if g.lang=='en' %}Email:{% else %}ელ. ფოსტა:{% endif %}</strong> <span id="summaryEmail"></span></p>
                    <p><strong>{% if g.lang=='en' %}Phone:{% else %}ტელეფონი:{% endif %}</strong> <span id="summaryPhone"></span></p>
                </div>

                <button type="submit" class="btn btn-confirm w-100 mt-3">{% if g.lang=='en' %}Confirm Booking{% else %}დადასტურება{% endif %}</button>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script type="text/javascript">
    emailjs.init("JU0qPiKzSmXsjH8F6");
</script>

<script>
    // Language detection for JS
    const currentLang = "{{ g.lang }}";

    $(document).ready(function() {
        $('#spotSelect').select2({
            placeholder: currentLang === 'en' ? "Search for a place..." : "მოძებნე ადგილი...",
            allowClear: true,
            width: '100%'
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('bookingForm');
        const summary = document.getElementById('summary');

        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const name = document.getElementById('nameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const spot = document.getElementById('spotSelect').value;
            const date = document.getElementById('dateInput').value;

            if (!name || !email || !phone || !spot || !date) {
                alert(currentLang === 'en' ? "Please fill in all required fields" : "გთხოვთ შეიყვანოთ ყველა აუცილებელი ველი");
                return;
            }

            // Update summary
            document.getElementById('summarySpot').textContent = spot;
            document.getElementById('summaryDate').textContent = date;
            document.getElementById('summaryName').textContent = name;
            document.getElementById('summaryEmail').textContent = email;
            document.getElementById('summaryPhone').textContent = phone;
            summary.style.display = 'block';
            summary.scrollIntoView({ behavior: "smooth" });

            fetch("{{ url_for('booking') }}", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    spot: spot,
                    date: date,
                    name: name,
                    email: email,
                    phone: phone
                })
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                }

                const templateParams = {
                    to_name: name,
                    to_email: email,
                    spot: spot,
                    date: date,
                    phone: phone
                };

                emailjs.send('service_92mfzff', 'template_d5vie7m', templateParams)
                    .then(function(res) {
                        console.log('Email sent', res.status, res.text);
                    }, function(err) {
                        console.error('EmailJS error', err);
                    });
            })
            .catch(err => {
                console.error(err);
                alert(currentLang === 'en' ? "Error! Please try again." : "შეცდომა! გთხოვთ სცადოთ თავიდან.");
            });
        });
    });
</script>
{% endblock %}