{% extends "base.html" %}

{% block title %}GreenSpots — {% if g.lang=='en' %}Map{% else %}რუკა{% endif %}{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="//cdn.web-fonts.ge/fonts/alk-life/css/alk-life.min.css">
{% endblock %}

{% block content %}
<section class="hero-section py-5 mt-5 text-center ">
    <div class="container">
        <h1 class="hero-title mb-2">
            {% if g.lang=='en' %}Interactive Map{% else %}ინტერაქტიული რუკა{% endif %}
        </h1>
        <p class="text-muted">
            {% if g.lang=='en' %}All added places on one map.{% else %}ყველა დამატებული ადგილი ერთ რუკაზე.{% endif %}
        </p>
    </div>
</section>

<section class="map-container">
    <div class="map-wrapper">
    <a href="{{ url_for('add_place') }}"
       class="btn btn-success btn-lg add-place-btn shadow-lg">
        <i class="bi bi-geo-alt me-2"></i>
        {% if g.lang=='en' %}Add a Place{% else %}დაამატე ადგილი{% endif %}
    </a>

    <div id="map"></div>
    </div>
</section>
{% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  // Initialize map
  const map = L.map('map').setView([41.7167, 44.7833], 7);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // Define language-specific strings for JS
  const lang = "{{ g.lang }}";
  const viewText = lang === 'en' ? "View" : "ნახვა";
  const noPlacesText = lang === 'en' ? "<b>No places added yet</b>" : "<b>ჯერ ადგილი არ არის დამატებული</b>";

  // Add real markers from backend
  {% if places %}
    {% for place in places %}
      L.marker([{{ place.latitude }}, {{ place.longitude }}])
        .addTo(map)
        .bindPopup(`
          <b>{{ place.name }}</b><br>
          <a href="{{ url_for('place_detail', place_id=place.id) }}">
            ${viewText}
          </a>
        `);
    {% endfor %}
  {% else %}
      L.popup()
        .setLatLng([41.7167, 44.7833])
        .setContent(noPlacesText)
        .openOn(map);
  {% endif %}

  // Animations
  function animateOnScroll() {
      const sections = document.querySelectorAll('.hero-section, .map-container');
      const triggerBottom = window.innerHeight * 0.85;

      sections.forEach(section => {
          const sectionTop = section.getBoundingClientRect().top;
          if (sectionTop < triggerBottom) {
              section.classList.add('show');
          }
      });
  }

  function showAddPlaceButton() {
      const addButton = document.querySelector('.add-place-btn');
      if(addButton) {
          setTimeout(() => {
              addButton.classList.add('show');
          }, 200);
      }
  }

  window.addEventListener('scroll', animateOnScroll);
  window.addEventListener('DOMContentLoaded', () => {
      animateOnScroll();
      showAddPlaceButton();
  });
</script>
{% endblock %}