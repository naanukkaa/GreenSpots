{% extends "base.html" %}

{% block title %}Profile — GreenSpots{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
<script>
    // This MUST run before any CSS loads to prevent the white flash
    (function() {
        const savedTheme = localStorage.getItem('gs-theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    })();
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<!-- Slick CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<section class="profile-header py-5 mt-5 text-center bg-light">
    <div class="container">
        <i class="bi bi-person-circle fs-1 mb-3"></i>
        <h1 class="hero-title">გამარჯობა, {{ current_user.username }}!</h1>
        <p class="hero-slogan-georgian">მოგესალმებით თქვენს პროფილში, შეგიძლიათ მართოთ ფავორიტები, გეგმები და პირადი ინფორმაცია.</p>
    </div>
</section>

<!-- Profile Details -->
<section class="profile-details py-5">
    <div class="container">
        <h2 class="mb-4">პირადი ინფორმაცია</h2>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card p-4 h-100">
                    <h5>მომხმარებლის დეტალები</h5>
                    <p><strong>სახელი:</strong> {{ current_user.username }}</p>
                    <p><strong>Email:</strong> {{ current_user.email }}</p>
                    <p><strong>ID:</strong> {{ current_user.id }}</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-4 h-100">
                    <h5>სტატისტიკა</h5>
                    <p><i class="bi bi-heart-fill text-danger"></i> ფავორიტები: {{ favorites|length }} ადგილი</p>
                    <p><i class="bi bi-map"></i> დაგეგმილი მარშრუტები: {{ planned_routes|length }}</p>
                    <p><i class="bi bi-star-fill text-warning"></i> საშუალო რეიტინგი: {{ avg_rating }}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="added-locs container">
    <h3 class="mb-4">ჩემი დამატებული ადგილები</h3>
    <div class="my-places-slider"> {% for place in my_places %}
            <div class="place-card">
                <img src="{{ url_for('static', filename='uploads/' ~ place.image) }}" alt="{{ place.name }}">
                <div class="place-info mt-2">
                    <h5 class="text-center">{{ place.name }}</h5>
                </div>
            </div>
        {% else %}
            <p>თქვენ ჯერ არ დაგიმატებიათ ადგილები.</p>
        {% endfor %}
    </div>
</section>

<!-- Favorites Slider -->
<section class="profile-favorites py-5 bg-light">
    <div class="container">
        <h2 class="mb-4">თქვენი ფავორიტები</h2>
        <div class="favorites-slider">
            {% for place in favorites %}
            <div class="card h-100 mx-2 favorite-item" id="favorite-{{ place.id }}">
                <img src="{{ url_for('static', filename='uploads/' ~ place.image) }}" class="card-img-top" alt="{{ place.name }}">
                <div class="card-body">
                    <h5 class="card-title">{{ place.name }}</h5>
                    <button type="button" class="btn btn-danger btn-sm" onclick="toggleFavorite({{ place.id }})">
                        წაშლა
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>


<!-- Planned Routes Slider -->
<section class="profile-routes py-5">
    <div class="container">
        <h2 class="mb-4">დაგეგმილი მარშრუტები</h2>
        <div class="routes-slider">
            {% for route in current_user.routes %}
              <div class="card p-3 h-100 mx-2">
                  <h5>{{ route.name }}</h5>
                  <p>გეგმაში: {{ route.date.strftime('%d %B') }} – {{ route.place.name }}</p>
                  <form method="POST" action="{{ url_for('delete_route', route_id=route.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger btn-sm">წაშლა</button>
                  </form>
              </div>
            {% endfor %}
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container text-center">
        <hr class="my-4">
        <h4 class="text-danger">საშიში ზონა</h4>
        <form action="{{ url_for('auth_bp.delete_account') }}" method="POST"
              onsubmit="return confirm('This will permanently delete your account. Are you sure?');">
            <button type="submit" class="btn btn-danger">
                Delete My Account
            </button>
        </form>
    </div>
</section>

{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>

<script>
// Use jQuery's ready function for everything
$(document).ready(function() {

    // 1. Initialize Sliders
    const $favSlider = $('.favorites-slider');

    $favSlider.slick({
        slidesToShow: 4,
        slidesToScroll: 1,
        autoplay: true,
        autoplaySpeed: 2500,
        arrows: true,
        dots: true,
        infinite: true,
        responsive: [
            { breakpoint: 1024, settings: { slidesToShow: 3 } },
            { breakpoint: 768, settings: { slidesToShow: 2 } },
            { breakpoint: 480, settings: { slidesToShow: 1 } }
        ]
    });

    $('.routes-slider').slick({
        slidesToShow: 3,
        slidesToScroll: 1,
        infinite: false,
        dots: true
    });

    // 2. Optimized toggleFavorite Function
    // We attach this to the window so the onclick calls can still find it
    window.toggleFavorite = function(placeId) {
        const csrfToken = $('meta[name="csrf-token"]').attr('content');

        if (!confirm('ნამდვილად გსურთ წაშლა?')) return;

        fetch(`/toggle_favorite/${placeId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(res => {
            if (!res.ok) throw new Error('Network error');
            return res.json();
        })
        .then(data => {
            if (data.status === 'removed') {
                // Find the specific slide element
                const $card = $(`#favorite-${placeId}`);

                // Get the correct index for Slick (ignoring cloned slides)
                const slideIndex = $card.closest('.slick-slide').data('slick-index');

                // Visual feedback: fade out
                $card.css('opacity', '0');

                setTimeout(() => {
                    // Use Slick's official remove method to clean up the carousel
                    $favSlider.slick('slickRemove', slideIndex);

                    // Force a recalculation of positions
                    $favSlider.slick('setPosition');

                    // If zero slides left, reload to show empty state
                    if ($favSlider.find('.card').length === 0) {
                        location.reload();
                    }
                }, 300);
            }
        })
        .catch(err => {
            console.error('Error:', err);
            alert('შეცდომა მოხდა წაშლისას');
        });
    };
});
</script>

<script>
$(document).ready(function(){
    $('.my-places-slider').slick({
        infinite: false, // Stops at the last added place
        slidesToShow: 4, // 4 items on desktop
        slidesToScroll: 1,
        autoplay: true,
        autoplaySpeed: 2500,
        dots: true,      // Shows those little navigation dots
        arrows: true,    // Shows left/right arrows
        infinite: true,
        responsive: [
            {
                breakpoint: 1024,
                settings: {
                    slidesToShow: 3
                }
            },
            {
                breakpoint: 768,
                settings: {
                    slidesToShow: 2
                }
            },
            {
                breakpoint: 480,
                settings: {
                    slidesToShow: 1,
                    arrows: false // Better for small mobile screens
                }
            }
        ]
    });
});
</script>
{% endblock %}