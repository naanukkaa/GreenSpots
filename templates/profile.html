{% extends "base.html" %}

{% block title %}Profile — GreenSpots{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
<!-- Slick CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>
{% endblock %}

{% block content %}
<!-- Profile Header -->
<section class="profile-header py-5 mt-5 text-center bg-light">
    <div class="container">
        <i class="bi bi-person-circle fs-1 mb-3"></i>
        <h1 class="hero-title">გამარჯობა, {{ current_user.username }}!</h1>
        <p class="hero-slogan-georgian">მოგესალმებით თქვენს პროფილში, შეგიძლიათ მართოთ ფავორიტები, გეგმები და პირადი ინფორმაცია.</p>
    </div>
</section>

<!-- Profile Details -->
<section class="profile-details py-5">
    <div class="container">
        <h2 class="mb-4">პირადი ინფორმაცია</h2>
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card p-4 h-100">
                    <h5>მომხმარებლის დეტალები</h5>
                    <p><strong>სახელი:</strong> {{ current_user.username }}</p>
                    <p><strong>Email:</strong> {{ current_user.email }}</p>
                    <p><strong>ID:</strong> {{ current_user.id }}</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-4 h-100">
                    <h5>სტატისტიკა</h5>
                    <p><i class="bi bi-heart-fill text-danger"></i> ფავორიტები: {{ favorites|length }} ადგილი</p>
                    <p><i class="bi bi-map"></i> დაგეგმილი მარშრუტები: {{ planned_routes|length }}</p>
                    <p><i class="bi bi-star-fill text-warning"></i> საშუალო რეიტინგი: {{ avg_rating }}</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section>
    <h3>My Places</h3>
    <div class="my-places">
        {% for place in my_places %}
            <div class="place-card">
                <img src="{{ url_for('static', filename='uploads/' ~ place.image) }}" alt="{{ place.name }}">
                <div class="place-info">
                    <h5>{{ place.name }}</h5>
                    <form method="POST" action="{{ url_for('delete_place', place_id=place.id) }}" onsubmit="return confirm('დარწმუნებული ხარ?');">
                        {{ csrf_token() }}
                        <button type="submit" class="btn btn-danger btn-sm">წაშლა</button>
                    </form>
                </div>
            </div>
        {% endfor %}
    </div>
</section>

<!-- Favorites Slider -->
<section class="profile-favorites py-5 bg-light">
    <div class="container">
        <h2 class="mb-4">თქვენი ფავორიტები</h2>
        <div class="favorites-slider">
            {% for place in favorites %}
            <div class="card h-100 mx-2" id="favorite-{{ place.id }}">
                <img src="{{ url_for('static', filename='uploads/' ~ place.image) }}" class="card-img-top" alt="{{ place.name }}">
                <div class="card-body">
                    <h5 class="card-title">{{ place.name }}</h5>
                    <form method="POST" action="{{ url_for('toggle_favorite', place_id=place.id) }}" style="display: inline;">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-danger btn-sm mt-2">
                            წაშლა
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>


<!-- Planned Routes Slider -->
<section class="profile-routes py-5">
    <div class="container">
        <h2 class="mb-4">დაგეგმილი მარშრუტები</h2>
        <div class="routes-slider">
            {% for route in current_user.routes %}
              <div class="card p-3 h-100 mx-2">
                  <h5>{{ route.name }}</h5>
                  <p>გეგმაში: {{ route.date.strftime('%d %B') }} – {{ route.place.name }}</p>
                  <form action="{{ url_for('delete_route', route_id=route.id) }}" method="POST" onsubmit="return confirm('გსურთ წაშლა?');">
                      <button type="submit" class="btn btn-outline-green">წაშლა</button>
                  </form>
              </div>
            {% endfor %}
        </div>
    </div>
</section>

<section class="py-5">
    <div class="container text-center">
        <hr class="my-4">
        <h4 class="text-danger">საშიში ზონა</h4>
        <form action="{{ url_for('auth_bp.delete_account') }}" method="POST"
              onsubmit="return confirm('This will permanently delete your account. Are you sure?');">
            <button type="submit" class="btn btn-danger">
                Delete My Account
            </button>
        </form>
    </div>
</section>

{% endblock %}

{% block js %}
<!-- jQuery (required by Slick) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Slick JS -->
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script>
    function toggleFavorite(placeId) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    fetch(`/toggle_favorite/${placeId}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,  // ← This is the key line
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else if (response.ok) {
            // Optionally remove the card from UI
            document.getElementById(`favorite-${placeId}`)?.remove();
        } else {
            alert('შეცდომა მოხდა');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('შეცდომა მოხდა');
    });
}
    .then(response => response.json())
    .then(data => {
        if (data.status === 'removed') {
            // Remove the card with animation
            const card = document.getElementById(`favorite-${placeId}`);
            card.style.opacity = '0';
            setTimeout(() => {
                card.remove();
                // Refresh slick slider
                $('.favorites-slider').slick('unslick');
                $('.favorites-slider').slick({
                    slidesToShow: 4,
                    slidesToScroll: 1,
                    autoplay: true,
                    autoplaySpeed: 2500,
                    arrows: true,
                    dots: true,
                    infinite: true,
                    pauseOnHover: true,
                    responsive: [
                        { breakpoint: 1024, settings: { slidesToShow: 3 } },
                        { breakpoint: 768, settings: { slidesToShow: 2 } },
                        { breakpoint: 480, settings: { slidesToShow: 1 } }
                    ]
                });
            }, 300);
        }
    })
    .catch(error => {
        alert('შეცდომა დაფიქსირდა!');
        console.error('Error:', error);
    });
}
</script>
<script>
$(document).ready(function(){
    // Favorites slider
    $('.favorites-slider').slick({
        slidesToShow: 4,
        slidesToScroll: 1,
        autoplay: true,
        autoplaySpeed: 2500,
        arrows: true,
        dots: true,
        infinite: true,
        pauseOnHover: true,
        responsive: [
            { breakpoint: 1024, settings: { slidesToShow: 3 } },
            { breakpoint: 768, settings: { slidesToShow: 2 } },
            { breakpoint: 480, settings: { slidesToShow: 1 } }
        ]
    });

    // Planned Routes slider
    $('.routes-slider').slick({
        slidesToShow: 3,
        slidesToScroll: 1,
        autoplay: true,
        autoplaySpeed: 3000,
        arrows: true,
        dots: true,
        infinite: true,
        pauseOnHover: true,
        responsive: [
            { breakpoint: 1024, settings: { slidesToShow: 2 } },
            { breakpoint: 768, settings: { slidesToShow: 1 } }
        ]
    });
});
</script>
{% endblock %}

