{% extends "base.html" %}
{% block title %}{{ place.name }} â€” GreenSpots{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
.btn-green {
    background-color: #28a745;
    color: white;
    border: 1px solid #28a745;
}
.btn-outline-green {
    background-color: transparent;
    color: #28a745;
    border: 1px solid #28a745;
}

/* IMAGE */
.img-banner {
    margin-top: 60px;
    width: 100%;
    height: 400px;
    object-fit: cover;
}

/* TITLE */
.head-text {
    font-size: 36px;
    font-weight: 700;
    margin-top: 20px;
}

/* DESCRIPTION */
.place-description {
    font-size: 20px;
    line-height: 1.6;
}
.star-rating {
    font-size: 30px;
    cursor: pointer;
    display: inline-block;
}
.star {
    color: gold;
    transition: transform 0.1s;
}
.star:hover,
.star.hover,
.star.selected {
    transform: scale(1.2);
}

/* MAP */
#place-map {
    width: 100%;
    height: 400px;
    border-radius: 12px;
    margin: 20px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Place Image & Title -->
    <div class="text-center mb-4">
        <img src="{{ url_for('static', filename='uploads/' ~ place.image) }}" class="img-banner" alt="{{ place.name }}">
        <h1 class="head-text">{{ place.name }}</h1>
        <p class="place-description">{{ place.description }}</p>

        <!-- Favorite & Route Buttons -->
        <div class="d-flex justify-content-center gap-2 mb-3">
            <button id="favorite-btn" data-id="{{ place.id }}" class="btn {% if place in current_user.favorites %}btn-green{% else %}btn-outline-green{% endif %}">
                {% if place in current_user.favorites %}áƒ¬áƒáƒ¨áƒáƒšáƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ˜áƒ“áƒáƒœ{% else %}áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ¨áƒ˜{% endif %}
            </button>
            <form method="POST">
                <input type="hidden" name="action" value="route">
                <button type="submit" class="btn btn-primary-green">áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ›áƒáƒ áƒ¨áƒ áƒ£áƒ¢áƒ¨áƒ˜</button>
            </form>
        </div>

        <!-- Admin Delete Button -->
       <form method="POST" action="{{ url_for('delete_place', place_id=place.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-danger">áƒ¬áƒáƒ¨áƒšáƒ</button>
        </form>

        <!-- Leaflet Map -->
        {% if place.latitude and place.longitude %}
        <div class="container">
            <h3>áƒáƒ“áƒ’áƒ˜áƒšáƒ˜áƒ¡ áƒ›áƒ“áƒ”áƒ‘áƒáƒ áƒ”áƒáƒ‘áƒ</h3>
            <div id="place-map"></div>
        </div>
        {% endif %}
    </div>

    <!-- Ratings & Comments -->
    <section>
        <h3>áƒ áƒ”áƒ˜áƒ¢áƒ˜áƒœáƒ’áƒ˜: {{ avg_rating }} / 5</h3>

        {% for rating in ratings %}
            <div class="card mb-3" id="rating-{{ rating.id }}">
                <div class="card-body d-flex justify-content-between align-items-start">
                    <div>
                        <p><strong>{{ rating.user.username }}</strong> â€“ {{ rating.stars }} â˜…</p>
                        <p>{{ rating.comment }}</p>
                        {% if rating.image %}
                        <img src="{{ url_for('static', filename='uploads/' ~ rating.image) }}" class="img-fluid rounded" style="max-width:200px;">
                        {% endif %}
                    </div>

                    {% if current_user.id == rating.user_id or current_user.is_admin %}
                    <button class="btn btn-outline-danger btn-sm delete-comment" data-id="{{ rating.id }}" title="Delete">
                        ğŸ—‘
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

        <h4>áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ¨áƒ”áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ</h4>
        <form method="POST" enctype="multipart/form-data" id="rating-form">
            <input type="hidden" name="action" value="rating">
            <input type="hidden" name="stars" id="rating-stars" value="0">

            <div class="star-rating mb-2">
                {% for i in range(1, 6) %}
                    <span class="star" data-value="{{ i }}">â˜†</span>
                {% endfor %}
            </div>

            <div class="mb-2">
                <label>Comment:</label>
                <textarea name="comment" rows="3" class="form-control"></textarea>
            </div>

            <div class="mb-2">
                <label>Upload Image:</label>
                <input type="file" name="image" class="form-control">
            </div>

            <button type="submit" class="btn btn-success">Submit</button>
        </form>
    </section>
</div>
{% endblock %}

{% block js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    // 1. --- HELPER CHECK ---
    // This ensures your postWithCSRF helper is actually found.
    const safePost = (url) => {
        if (typeof postWithCSRF === 'function') {
            return postWithCSRF(url);
        } else {
            // Fallback if helper is missing
            const token = document.querySelector('meta[name="csrf-token"]')?.content;
            return fetch(url, {
                method: "POST",
                headers: { "X-CSRFToken": token, "Content-Type": "application/json" }
            });
        }
    };

    // 2. --- FAVORITE BUTTON ---
    const favoriteBtn = document.getElementById('favorite-btn');
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function () {
            const btn = this;
            const placeId = btn.dataset.id;

            safePost(`/toggle_favorite/${placeId}`)
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                })
                .then(data => {
                    if (data.status === 'added') {
                        btn.textContent = 'áƒ¬áƒáƒ¨áƒáƒšáƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ˜áƒ“áƒáƒœ';
                        btn.className = 'btn btn-green';
                    } else if (data.status === 'removed') {
                        btn.textContent = 'áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ¨áƒ˜';
                        btn.className = 'btn btn-outline-green';
                    }
                })
                .catch(err => {
                    console.error("Favorite Error:", err);
                    alert("áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ¨áƒ˜ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ¡áƒáƒ¡");
                });
        });
    }

    // 3. --- DELETE COMMENT ---
    document.querySelectorAll('.delete-comment').forEach(btn => {
        btn.addEventListener('click', () => {
            const ratingId = btn.dataset.id;
            if (!confirm("áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ—?")) return;

            safePost(`/delete_rating/${ratingId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById(`rating-${ratingId}`)?.remove();
                    } else {
                        alert(data.message || "áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ¬áƒáƒ¨áƒšáƒ˜áƒ¡áƒáƒ¡");
                    }
                })
                .catch(err => console.error("Delete Error:", err));
        });
    });

    // 4. --- STAR RATING LOGIC ---
    const stars = document.querySelectorAll('.star-rating .star');
    const hiddenInput = document.getElementById('rating-stars');

    if (stars.length > 0) {
        function highlightStars(rating) {
            stars.forEach(star => {
                const val = parseInt(star.dataset.value);
                star.textContent = val <= rating ? 'â˜…' : 'â˜†';
                star.classList.toggle('selected', val <= rating);
            });
        }

        stars.forEach(star => {
            star.addEventListener('mouseover', () => highlightStars(parseInt(star.dataset.value)));
            star.addEventListener('mouseout', () => highlightStars(parseInt(hiddenInput.value || 0)));
            star.addEventListener('click', () => {
                const val = parseInt(star.dataset.value);
                hiddenInput.value = val;
                highlightStars(val);
            });
        });
    }

    // 5. --- MAP INITIALIZATION ---
    {% if place.latitude and place.longitude %}
    try {
        const map = L.map('place-map').setView([{{ place.latitude }}, {{ place.longitude }}], 14);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        L.marker([{{ place.latitude }}, {{ place.longitude }}])
            .addTo(map)
            .bindPopup("<b>{{ place.name }}</b><br><a href='https://www.google.com/maps?q={{ place.latitude }},{{ place.longitude }}' target='_blank'>Google Maps</a>")
            .openPopup();

        setTimeout(() => { map.invalidateSize(); }, 200);
    } catch (e) {
        console.error("Map initialization failed:", e);
    }
    {% endif %}
});

// 6. --- DELETE PLACE (GLOBAL) ---
function deletePlace(placeId) {
    const token = document.querySelector('meta[name="csrf-token"]')?.content;
    if (confirm('áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ— áƒ áƒáƒ› áƒ’áƒ¡áƒ£áƒ áƒ— áƒ¬áƒáƒ¨áƒšáƒ?')) {
        fetch(`/delete_place/${placeId}`, {
            method: 'POST',
            headers: { 'X-CSRFToken': token, 'Content-Type': 'application/json' }
        })
        .then(response => {
            if (response.redirected) window.location.href = response.url;
        })
        .catch(err => console.error("Delete Place Error:", err));
    }
}
</script>
{% endblock %}
