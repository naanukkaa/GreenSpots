{% extends "base.html" %}
{% block title %}{{ place.name }} â€” GreenSpots{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reset.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
.btn-green { background-color: #28a745; color: white; border: 1px solid #28a745; }
.btn-outline-green { background-color: transparent; color: #28a745; border: 1px solid #28a745; }
.img-banner { margin-top: 60px; width: 100%; height: 400px; object-fit: cover; }
.head-text { font-size: 36px; font-weight: 700; margin-top: 20px; }
.place-description { font-size: 20px; line-height: 1.6; }
.star-rating { font-size: 30px; cursor: pointer; display: inline-block; }
.star { color: gold; transition: transform 0.1s; }
.star:hover, .star.hover, .star.selected { transform: scale(1.2); }
#place-map { width: 100%; height: 400px; border-radius: 12px; margin: 20px 0; }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-4">
        <img src="{{ url_for('static', filename='uploads/' ~ place.image) }}" class="img-banner" alt="{{ place.name }}">
        <h1 class="head-text">{{ place.name }}</h1>
        <p class="place-description">{{ place.description }}</p>

        <div class="d-flex justify-content-center gap-2 mb-3">
            <button id="favorite-btn" data-id="{{ place.id }}" class="btn {% if place in current_user.favorites %}btn-green{% else %}btn-outline-green{% endif %}">
                {% if place in current_user.favorites %}
                    {% if g.lang=='en' %}Remove from Favorites{% else %}áƒ¬áƒáƒ¨áƒáƒšáƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ˜áƒ“áƒáƒœ{% endif %}
                {% else %}
                    {% if g.lang=='en' %}Add to Favorites{% else %}áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ¨áƒ˜{% endif %}
                {% endif %}
            </button>
            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <input type="hidden" name="action" value="route">
                <button type="submit" class="btn btn-primary-green">
                    {% if g.lang=='en' %}Add to Route{% else %}áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ›áƒáƒ áƒ¨áƒ áƒ£áƒ¢áƒ¨áƒ˜{% endif %}
                </button>
            </form>
        </div>

        {% if current_user.is_admin %}
       <form method="POST" action="{{ url_for('delete_place', place_id=place.id) }}" onsubmit="return confirm('{% if g.lang == "en" %}Delete this place permanently?{% else %}áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ— áƒ áƒáƒ› áƒ’áƒ¡áƒ£áƒ áƒ— áƒ¬áƒáƒ¨áƒšáƒ?{% endif %}');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-danger">
                {% if g.lang=='en' %}Delete Place{% else %}áƒ¬áƒáƒ¨áƒšáƒ{% endif %}
            </button>
        </form>
        {% endif %}

        {% if place.latitude and place.longitude %}
        <div class="container mt-5">
            <h3>{% if g.lang=='en' %}Location{% else %}áƒáƒ“áƒ’áƒ˜áƒšáƒ˜áƒ¡ áƒ›áƒ“áƒ”áƒ‘áƒáƒ áƒ”áƒáƒ‘áƒ{% endif %}</h3>
            <div id="place-map"></div>
        </div>
        {% endif %}
    </div>

    <section>
        <h3>{% if g.lang=='en' %}Rating{% else %}áƒ áƒ”áƒ˜áƒ¢áƒ˜áƒœáƒ’áƒ˜{% endif %}: {{ avg_rating }} / 5</h3>

        {% for rating in ratings %}
            <div class="card mb-3" id="rating-{{ rating.id }}">
                <div class="card-body d-flex justify-content-between align-items-start">
                    <div>
                        <p><strong>{{ rating.user.username }}</strong> â€“ {{ rating.stars }} â˜…</p>
                        <p>{{ rating.comment }}</p>
                        {% if rating.image %}
                        <img src="{{ url_for('static', filename='uploads/' ~ rating.image) }}" class="img-fluid rounded" style="max-width:200px;">
                        {% endif %}
                    </div>

                    {% if current_user.id == rating.user_id or current_user.is_admin %}
                    <button class="btn btn-outline-danger btn-sm delete-comment" data-id="{{ rating.id }}">
                        ğŸ—‘
                    </button>
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <h4 class="mt-5">{% if g.lang=='en' %}Your Review{% else %}áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ¨áƒ”áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ{% endif %}</h4>
        <form method="POST" enctype="multipart/form-data" id="rating-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <input type="hidden" name="action" value="rating">
            <input type="hidden" name="stars" id="rating-stars" value="0">

            <div class="star-rating mb-2">
                {% for i in range(1, 6) %}
                    <span class="star" data-value="{{ i }}">â˜†</span>
                {% endfor %}
            </div>

            <div class="mb-2">
                <label>{% if g.lang=='en' %}Comment:{% else %}áƒ™áƒáƒ›áƒ”áƒœáƒ¢áƒáƒ áƒ˜:{% endif %}</label>
                <textarea name="comment" rows="3" class="form-control" placeholder="{% if g.lang=='en' %}Write your thoughts...{% else %}áƒ“áƒáƒ¬áƒ”áƒ áƒ”áƒ— áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒáƒ–áƒ áƒ˜...{% endif %}"></textarea>
            </div>

            <div class="mb-2">
                <label>{% if g.lang=='en' %}Upload Image:{% else %}áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ” áƒ¤áƒáƒ¢áƒ:{% endif %}</label>
                <input type="file" name="image" class="form-control">
            </div>

            <button type="submit" class="btn btn-success">
                {% if g.lang=='en' %}Submit{% else %}áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ{% endif %}
            </button>
        </form>
    </section>
</div>
{% endblock %}

{% block js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const currentLang = "{{ g.lang }}";

    // CSRF Helper
    const safePost = (url) => {
        const token = document.querySelector('meta[name="csrf-token"]')?.content;
        return fetch(url, {
            method: "POST",
            headers: { "X-CSRFToken": token, "Content-Type": "application/json" }
        });
    };

    // Favorite Toggle
    const favoriteBtn = document.getElementById('favorite-btn');
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function () {
            const btn = this;
            safePost(`/toggle_favorite/${btn.dataset.id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'added') {
                        btn.textContent = currentLang === 'en' ? 'Remove from Favorites' : 'áƒ¬áƒáƒ¨áƒáƒšáƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ˜áƒ“áƒáƒœ';
                        btn.className = 'btn btn-green';
                    } else {
                        btn.textContent = currentLang === 'en' ? 'Add to Favorites' : 'áƒ“áƒáƒáƒ›áƒáƒ¢áƒ” áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ¨áƒ˜';
                        btn.className = 'btn btn-outline-green';
                    }
                })
                .catch(() => alert(currentLang === 'en' ? "Error updating favorites" : "áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ¤áƒáƒ•áƒáƒ áƒ˜áƒ¢áƒ”áƒ‘áƒ¨áƒ˜ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ¡áƒáƒ¡"));
        });
    }

    // Delete Comment
    document.querySelectorAll('.delete-comment').forEach(btn => {
        btn.addEventListener('click', () => {
            const confirmMsg = currentLang === 'en' ? "Are you sure?" : "áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ—?";
            if (!confirm(confirmMsg)) return;

            safePost(`/delete_rating/${btn.dataset.id}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') document.getElementById(`rating-${btn.dataset.id}`)?.remove();
                });
        });
    });

    // Star Rating
    const stars = document.querySelectorAll('.star-rating .star');
    const hiddenInput = document.getElementById('rating-stars');
    const highlightStars = (rating) => {
        stars.forEach(star => {
            const val = parseInt(star.dataset.value);
            star.textContent = val <= rating ? 'â˜…' : 'â˜†';
        });
    };

    stars.forEach(star => {
        star.addEventListener('mouseover', () => highlightStars(parseInt(star.dataset.value)));
        star.addEventListener('mouseout', () => highlightStars(parseInt(hiddenInput.value || 0)));
        star.addEventListener('click', () => {
            hiddenInput.value = star.dataset.value;
            highlightStars(star.dataset.value);
        });
    });

    // Bilingual Map with CartoDB for English labels
    {% if place.latitude and place.longitude %}
    try {
        const map = L.map('place-map').setView([{{ place.latitude }}, {{ place.longitude }}], 14);

        const tileUrl = currentLang === 'en'
            ? 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'
            : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

        L.tileLayer(tileUrl, { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

        // Define the labels based on language
        const gMapsLabel = currentLang === 'en' ? 'Open in Google Maps' : 'áƒœáƒáƒ®áƒ•áƒ Google Maps-áƒ–áƒ”';

        // Add the marker with a link in the popup
        L.marker([{{ place.latitude }}, {{ place.longitude }}])
            .addTo(map)
            .bindPopup(`
                <div style="text-align: center;">
                    <b style="display: block; margin-bottom: 8px;">{{ place.name }}</b>
                    <a href="https://www.google.com/maps/search/?api=1&query={{ place.latitude }},{{ place.longitude }}"
                       target="_blank"
                       class="btn btn-sm btn-primary-green text-white"
                       style="font-size: 12px; padding: 5px 10px;">
                       ${gMapsLabel}
                    </a>
                </div>
            `)
            .openPopup();

    } catch (e) { console.error("Map failed:", e); }
    {% endif %}
});
</script>
{% endblock %}