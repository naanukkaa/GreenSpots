{% extends "base.html" %}

{% block title %}
    {% if g.lang=='en' %}Add Place{% else %}ადგილის დამატება{% endif %} — GreenSpots
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">>
<link rel="stylesheet" href="//cdn.web-fonts.ge/fonts/alk-life/css/alk-life.min.css">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/logo.png') }}">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<style>
    .form-container {
        max-width: 700px;
        margin: 50px auto;
        padding: 30px;
        background-color: #f9f9f9;
        border-radius: 12px;
        box-shadow: 0px 4px 15px rgba(0,0,0,0.1);
    }
    .form-container h2 {
        text-align: center;
        color: #2b9348;
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        font-weight: 600;
    }
    .form-control {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
    button.btn-submit {
        background-color: #2b9348;
        color: #fff;
        width: 100%;
        padding: 12px;
        border-radius: 6px;
        font-weight: bold;
        transition: 0.3s;
    }
    button.btn-submit:hover {
        background-color: #237a3d;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <h2>{% if g.lang=='en' %}Add New Place{% else %}ახალი ადგილის დამატება{% endif %}</h2>

    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.name.label (class="form-label")}}
            {{ form.name(class="form-control", placeholder=("Enter name..." if g.lang=='en' else "ადგილის სახელი")) }}
        </div>

        <div class="form-group">
            {{ form.description.label (class="form-label")}}
            {{ form.description(class="form-control", placeholder=("Description..." if g.lang=='en' else "აღწერა")) }}
        </div>

        <div class="form-group">
            {{ form.category.label (class="form-label")}}
            {{ form.category(class="form-control") }}
        </div>

        <div class="form-group">
            {{ form.region.label (class="form-label")}}
            {{ form.region(class="form-control") }}
        </div>

        <div class="form-group">
            {{ form.image.label (class="form-label")}}
            {{ form.image(class="form-control") }}
        </div>

        <p id="map-warning" style="color:red; display:none; margin-bottom:10px;">
            {% if g.lang=='en' %}Please select a location on the map{% else %}გთხოვ აირჩიე ადგილი რუკაზე{% endif %}
        </p>

        <div class="row mb-3">
            <div class="col-md-5">
                <label>{% if g.lang=='en' %}Latitude{% else %}განედი (Lat){% endif %}</label>
                <input type="number" step="any" id="manualLat" class="form-control" placeholder="41.7151">
            </div>
            <div class="col-md-5">
                <label>{% if g.lang=='en' %}Longitude{% else %}გრძედი (Lng){% endif %}</label>
                <input type="number" step="any" id="manualLng" class="form-control" placeholder="44.8271">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" id="btnGoToCoords" class="btn btn-primary-green w-100">
                    {% if g.lang=='en' %}Go{% else %}ნახვა{% endif %}
                </button>
            </div>
        </div>

        <div id="map" style="height: 400px;"></div>

        <input type="hidden" name="latitude" id="finalLat">
        <input type="hidden" name="longitude" id="finalLng">

        <button type="submit" class="btn-submit" onclick="return validateMap();">
            {% if g.lang=='en' %}Add Place{% else %}დაამატე ადგილი{% endif %}
        </button>
    </form>
</div>
{% endblock %}

{% block js %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const currentLang = "{{ g.lang }}";

    // Initialize Map
    const map = L.map('map').setView([41.7167, 44.7833], 7);

    // Choose tile layer based on language
    const tileUrl = currentLang === 'en'
        ? 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png'
        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

    L.tileLayer(tileUrl, { attribution: '© OpenStreetMap' }).addTo(map);

    let marker;

    // Core function to move marker and update data
    function updateLocation(lat, lng, moveMap = true) {
        const coords = [lat, lng];

        if (marker) {
            marker.setLatLng(coords);
        } else {
            marker = L.marker(coords, { draggable: true }).addTo(map);

            // If user drags the marker, update the text boxes
            marker.on('dragend', function(e) {
                const pos = e.target.getLatLng();
                syncInputs(pos.lat, pos.lng);
            });
        }

        if (moveMap) map.flyTo(coords, 14);
        syncInputs(lat, lng);
    }

    // Helper to keep all inputs in sync
    function syncInputs(lat, lng) {
        const fixedLat = parseFloat(lat).toFixed(6);
        const fixedLng = parseFloat(lng).toFixed(6);

        document.getElementById('manualLat').value = fixedLat;
        document.getElementById('manualLng').value = fixedLng;
        document.getElementById('finalLat').value = fixedLat;
        document.getElementById('finalLng').value = fixedLng;
    }

    // 1. Handle "Locate" Button click
    document.getElementById('btnGoToCoords').addEventListener('click', () => {
        const lat = parseFloat(document.getElementById('manualLat').value);
        const lng = parseFloat(document.getElementById('manualLng').value);

        if (!isNaN(lat) && !isNaN(lng)) {
            updateLocation(lat, lng);
        } else {
            alert(currentLang === 'en' ? "Please enter valid coordinates" : "შეიყვანეთ სწორი კოორდინატები");
        }
    });

    // 2. Handle Map Click
    map.on('click', (e) => {
        updateLocation(e.latlng.lat, e.latlng.lng, false);
    });
});
</script>
{% endblock %}